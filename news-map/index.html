<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>COJMC News Map - Layers</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">


<link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>

<!-- Load the `mapbox-gl-geocoder` plugin. -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

<style>
	body { margin: 0; padding: 0; font-family: system-ui, sans-serif; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
	
	#menu { background: #fff; position: absolute; z-index: 1; top: 60px; left: 10px; width: 150px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.15); border-radius: 5px; }

	#menu a { font-size: 13px; color: #404040; display: block; margin: 0; padding: 10px; text-decoration: none; border-bottom: 1px solid rgba(0, 0, 0, 0.25); text-align: left; }

	#menu a:last-child { border: none; }

	#menu a:hover { background-color: #f8f8f8; color: #404040; }

	#menu a.active { background-color: #3887be; color: #ffffff; }
	
	#menu p { padding: 10px; margin: 0; font-size: 13px; background: #eee; font-weight: bold; }
	
	.map-overlay {  position: absolute;  bottom: 0; right: 0; background: rgba(255,255,255,0.8);  margin-right: 10px;  font-size: 12px;   overflow: auto; padding: 10px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.15); }
		
	#legend {  box-shadow: 0 1px 2px rgba(0 0 0 0.1); line-height: 18px; height: 50px; margin-bottom: 30px; width: 100px; }
	
	.legend-key { display: inline-block; width: 10px; height: 10px; margin-right: 5px; }
</style>

</head>

<body>

	<nav id="menu"><p>News Desert Layers</nav>

	<div id="map"></div>

	<div class="map-overlay" id="legend">
		<p>[ Map legend can go down here? ]</p>
	</div>

<script>
	
	// Eds note: Does this work? 
	const bounds = [  
		[ -108.32, 37.57 ],
		[ -90.35, 45.54 ]
	];  
	
	// Load initial map
	mapboxgl.accessToken = 'pk.eyJ1IjoiYnZhbmthdCIsImEiOiJjbHhlemU4bmcwMjVqMmxwdzRhYXNpMXR3In0.9nLycyn371SDdXa_rdOTuA'; //Mapbox token COJMC News Map
	
	const map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/bvankat/clzx3cfap007501qr6xlh9qn6',
		zoom: 5.5,
		maxZoom: 9,
		center: [-100, 41.5],
		maxBounds: bounds
	});
	
	// Add search control (geocoder)	
	const geocoder = new MapboxGeocoder({
		accessToken: mapboxgl.accessToken,
		mapboxgl: mapboxgl,
		placeholder: 'Find address or zip',
		bbox: [-104.053514, 39.999751, -95.30829, 43.001707] // Bounding box for Nebraska
	});
	
	// Zoom controls
	map.addControl(geocoder, 'top-left');
	map.scrollZoom.disable();
	var nav = new mapboxgl.NavigationControl();
	map.addControl(nav, 'top-right');
	
	
	// Let's add some layers
	
	map.on('load', function () {
	
		map.addSource('Demographics', {
			type: 'geojson',
			// Use a URL for the value for the `data` property.
			data: '../data/2022-5YACS-DEMOGRAPHICS.geojson',
			generateId: true
			});
		
		map.addLayer({
			'id': 'Race % - White',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'Race % - Hispanic',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'Bachelors Degree',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'US Born',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'Veterans',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'Own vs. Rent',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
	});
	
	// After the last frame rendered before the map enters an "idle" state.
	map.on('idle', () => {
		
		// Set up the choropleth color scale based on the margin of victory
		map.setPaintProperty('2020 Presidential', 'fill-color', [
			'interpolate',
			['linear'],
			['abs', ['-', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']]],
			// Define breakpoints for margin values and corresponding colors
			0, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FFBFBF', // Light red for Trump with small margin
				'#BFBFFF'  // Light blue for Biden with small margin
			],
			25, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF8080', // Darker red for Trump
				'#8080FF'  // Darker blue for Biden
			],
			50, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF4040', // Even darker red for Trump
				'#4040FF'  // Even darker blue for Biden
			],
			75, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF0000', // Darkest red for Trump
				'#0000FF'  // Darkest blue for Biden
			]
		]);
		
		// Optionally adjust the opacity if needed
		map.setPaintProperty('2020 Presidential', 'fill-opacity', 0.6);
		
		

		// Enumerate ids of the layers.
		const toggleableLayerIds = [
			'Broadcast LNOs',
			'NPM Broadcast',
			'Statewide News Orgs',
			'LNOs - Print-Digital',
			'Staffing - Counties',
			'Race % - White', 
			'Race % - Hispanic', 
			'Bachelors Degree', 
			'US Born', 
			'Veterans', 
			'Own vs. Rent', 
			'2020 Presidential', 
			'Registered Voters', 
			'Broadband Cities', 
			'Broadband Counties', 
		];

		// Set up the corresponding toggle button for each layer.
		for (const id of toggleableLayerIds) {
			// Skip layers that already have a button set up.
			if (document.getElementById(id)) {
				continue;
			}

			// Create a link.
			const link = document.createElement('a');
			link.id = id;
			link.href = '#';
			link.textContent = id;
			link.className = '';

			// Show or hide layer when the toggle is clicked.
			link.onclick = function (e) {
				const clickedLayer = this.textContent;
				e.preventDefault();
				e.stopPropagation();
			
				const visibility = map.getLayoutProperty(
					clickedLayer,
					'visibility'
				);
			
				// Toggle layer visibility by changing the layout object's visibility property.
				if (visibility === 'visible') {
					map.setLayoutProperty(clickedLayer, 'visibility', 'none');
					this.className = '';
				} else {
					this.className = 'active';
					map.setLayoutProperty(
						clickedLayer,
						'visibility',
						'visible'
					);
				}
			
			};

			const layers = document.getElementById('menu');
			layers.appendChild(link);
		}
		
		
	});
		var currentPopup;
		
		// Broadcast LNO popups
		map.on('click', 'Broadcast LNOs', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var coordinates = e.features[0].geometry.coordinates.slice();
			var callsign = e.features[0].properties.callsign;
			var freq = e.features[0].properties.frequency;
			var service = e.features[0].properties.service;
			var owner = e.features[0].properties.newsorg_ow;
		
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML("<p><strong>" + callsign + "</strong></p><p>Station owner: " + owner + "</p><p>Frequency: " + freq + " " + service + "</p>")
				.addTo(map);
		});
		
		
		// 2020 Presidential layer popups
		map.on('click', '2020 Presidential', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var coordinates = e.features[0].geometry.coordinates.slice();
			var county = e.features[0].properties.NAME;
			var trump = e.features[0].properties.Trump_PCT;
			var biden = e.features[0].properties.Biden_PCT;
			var margin = Math.abs(trump - biden).toFixed(2); // Rounded to 2 decimal places
			var winner = trump > biden ? 'Trump' : 'Biden'; // Determine the winner
		
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML("<p><strong>" + county + " County</strong></p><p>2020 result: " + winner + " +" + margin + "%</p")
				.addTo(map);
		});
		
		// Demographics layer popups
		map.on('click', 'Race % - White', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var coordinates = e.features[0].geometry.coordinates.slice();
			var county = e.features[0].properties.NAMELSAD;
			var asian = e.features[0].properties.Asian;
			var black = e.features[0].properties.Black;
			var hispanic = e.features[0].properties.Hispanic;
			var white = e.features[0].properties.White;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>POPULATION BY RACE</p>" +
					"<p>Asian: " + asian + "%</p>" +
					"<p>Black: " + black + "%</p>" + 
					"<p>Hispanic: " + hispanic + "%</p>" +
					"<p>White: " + white + "%</p>")
				.addTo(map);
		});
		
		map.on('click', 'Race % - Hispanic', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var coordinates = e.features[0].geometry.coordinates.slice();
			var county = e.features[0].properties.NAMELSAD;
			var asian = e.features[0].properties.Asian;
			var black = e.features[0].properties.Black;
			var hispanic = e.features[0].properties.Hispanic;
			var white = e.features[0].properties.White;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>POPULATION BY RACE</p>" +
					"<p>Asian: " + asian + "%</p>" +
					"<p>Black: " + black + "%</p>" + 
					"<p>Hispanic: " + hispanic + "%</p>" +
					"<p>White: " + white + "%</p>")
				.addTo(map);
		});
		
		
</script>

</body>
</html>