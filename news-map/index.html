<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>COJMC News Map - Layers</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">


<link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>

<!-- Load the `mapbox-gl-geocoder` plugin. -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

<style>
	body { margin: 0; padding: 0; font-family: system-ui, sans-serif; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
	
	.map-menu { background: #fff; position: absolute; z-index: 1; left: 10px; width: 200px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.15); border-radius: 5px; }
	
	#menus { top: 60px; padding: 40px 0 0 0; }
	
	#menu-news, #menu-demographics { position: relative; margin-top: 20px; }
	
	#menu-demographics select { appearance: none; cursor: pointer; font-size: 12px; border: 1px solid #eee; padding: 5px; margin: 10px; border: 1px solid #eee; }

	.map-menu a { font-size: 13px; color: #404040; display: block; margin: 0; padding: 10px; text-decoration: none; border-bottom: 1px solid rgba(0, 0, 0, 0.25); text-align: left; }

	.map-menu a:last-child { border: none; }

	.map-menu a:hover { background-color: #f8f8f8; color: #404040; }

	.map-menu a.active { background-color: #d0000060; color: #000; }
	
	.map-menu p { padding: 10px; margin: 0; font-size: 13px; background: #d00000; color: #fff; font-weight: bold; }
	
	#menu-demographics p { background: #404040; color: #fff; font-weight: bold; }
	
	.map-overlay {  position: absolute;  bottom: 0; right: 0; background: rgba(255,255,255,0.8);  margin-right: 10px;  font-size: 12px;   overflow: auto; padding: 10px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.15); }
		
	#legend {  box-shadow: 0 1px 2px rgba(0 0 0 0.1); line-height: 18px; height: 50px; margin-bottom: 30px; width: 100px; }
	
	.legend-key { display: inline-block; width: 10px; height: 10px; margin-right: 5px; }
	
	.mapboxgl-popup { max-width: 320px; }
	.mapboxgl-popup-content { font-family: system-ui, sans-serif; padding: 15px; border-radius: 8px; }
	.mapboxgl-popup-content p { font-size: 13px; line-height: 1.5; margin: 0; }
	.mapboxgl-popup-content p.small { font-size: 11px; color: #aaa; margin-bottom: 5px; }
	.mapboxgl-popup-content h3 { margin: 0 0 5px 0; }
	.mapboxgl-popup-content table { width: 100%; border-collapse: collapse; margin-top: 5px; color: #666; }
	.mapboxgl-popup-content table th { text-transform: uppercase; font-size: 90%; text-align: left; padding: 3px 0; border-bottom: 1px solid #ccc; font-weight: normal; color: #999; }
	.mapboxgl-popup-content table td { vertical-align: top; padding: 5px 0; border-bottom: 1px solid #eee; font-weight: 400; line-height: 1.3; padding-right: 10px; }
	.mapboxgl-popup-content table td:first-child { font-weight: 600; }
	.mapboxgl-popup-content table td:last-child { padding-right: 0; }
	.mapboxgl-popup-content table.numbers td:last-child { text-align: right; }
	
	h3.outlets { margin-top: 20px; }
	
</style>

</head>

<body>


	<div id="menus">
		
		<nav id="menu-news" class="map-menu"><p>NEWS OUTLETS</p></nav>
	
	</div>
	
		<nav id="menu-demographics" class="map-menu"><p>DATA LAYERS</p>
			<select id="layer-switcher">
				<option value="">Select a layer</option>
				<option value="Journalists per County" selected>Journalists per County</option>
				<option value="Outlets per County">News Outlets per County</option>
				<option value="Race % - White">White %</option>
				<option value="Race % - Hispanic">Hispanic %</option>
				<option value="US Born">U.S. Citizenship</option>
				<option value="Veterans">Veterans</option>
				<option value="Own vs. Rent">Home Ownership</option>
				<option value="Education">Education</option>
				<option value="2020 Presidential">2020 Election</option>
				<option value="Registered Voters">Registered Voters</option>
				<option value="Broadband Counties">Broadband - Counties</option>
				<option value="Broadband Cities">Broadband - Cities</option>
			</select>
		</nav>
	

	<div id="map"></div>

	<div class="map-overlay" id="legend">
		<p>[ Map legend can go down here? ]</p>
	</div>

<script>
	
	// Eds note: Does this work? 
	const bounds = [  
		[ -108.32, 37.57 ],
		[ -90.35, 45.54 ]
	];  
	
	// Load initial map
	mapboxgl.accessToken = 'pk.eyJ1IjoiYnZhbmthdCIsImEiOiJjbHhlemU4bmcwMjVqMmxwdzRhYXNpMXR3In0.9nLycyn371SDdXa_rdOTuA'; //Mapbox token COJMC News Map
	
	const map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/bvankat/clzx3cfap007501qr6xlh9qn6',
		zoom: 5.5,
		maxZoom: 9,
		center: [-100, 41.5],
		maxBounds: bounds
	});
	
	// Add search control (geocoder)	
	const geocoder = new MapboxGeocoder({
		accessToken: mapboxgl.accessToken,
		mapboxgl: mapboxgl,
		placeholder: 'Find address or zip',
		bbox: [-104.053514, 39.999751, -95.30829, 43.001707] // Bounding box for Nebraska
	});
	
	// Zoom controls
	map.addControl(geocoder, 'top-left');
	map.scrollZoom.disable();
	var nav = new mapboxgl.NavigationControl();
	map.addControl(nav, 'top-right');
	
	
	// Let's add some layers
	
	map.on('load', function () {
	

		map.addSource('Demographics', {
			type: 'geojson',
			// Use a URL for the value for the `data` property.
			data: '../data/2022-5YACS-DEMOGRAPHICS.geojson',
			generateId: true
			});
		
		map.addLayer({
			'id': 'Race % - White',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'White'], // Feature property to base the colors on
					0, '#ffffd4',  
					20, '#fee391',
					40, '#fec44f',
					60, '#fe9929',
					80, '#d95f0e',  
					100, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'Race % - Hispanic',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'Hispanic'], // Feature property to base the colors on
					0, '#ffffd4',  
					10, '#fee391',
					20, '#fec44f',
					30, '#fe9929',
					40, '#d95f0e',  
					50, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'Education',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'Bach'], // Feature property to base the colors on
					5, '#ffffd4',  
					10, '#fee391',
					15, '#fec44f',
					20, '#fe9929',
					25, '#d95f0e',  
					30, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'US Born',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'USb'], // Feature property to base the colors on
					0, '#ffffd4',  
					20, '#fee391',
					40, '#fec44f',
					60, '#fe9929',
					80, '#d95f0e',  
					100, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'Veterans',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'Veteran'], // Feature property to base the colors on
					0, '#ffffd4',  
					10, '#fee391',
					20, '#fec44f',
					30, '#fe9929',
					40, '#d95f0e',  
					50, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'Own vs. Rent',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'Owneroccupied'], // Feature property to base the colors on
					0, '#ffffd4',  
					20, '#fee391',
					40, '#fec44f',
					60, '#fe9929',
					80, '#d95f0e',  
					100, '#993404'   
				]
		  	}
		}); 
		
		// Move layer to top
		map.moveLayer('Local and Statewide Outlets', 'Journalists per County');
			
		const mapLayers = map.getStyle().layers;
		console.log('Layers loaded: ', mapLayers);
	});
	
	// After the last frame rendered before the map enters an "idle" state.
	map.on('idle', () => {
		
		// Set up the choropleth color scale for '2020 Presidential' based on the margin of victory
		map.setPaintProperty('2020 Presidential', 'fill-color', [
			'interpolate',
			['linear'],
			['abs', ['-', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']]],
			// Define breakpoints for margin values and corresponding colors
			0, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FFBFBF', // Light red for Trump with small margin
				'#BFBFFF'  // Light blue for Biden with small margin
			],
			25, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF8080', // Darker red for Trump
				'#8080FF'  // Darker blue for Biden
			],
			50, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF4040', // Even darker red for Trump
				'#4040FF'  // Even darker blue for Biden
			],
			75, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF0000', // Darkest red for Trump
				'#0000FF'  // Darkest blue for Biden
			]
		]);
		
		// Set up the choropleth color scale for 'Registered Voters' based on the highest registrations
		map.setPaintProperty('Registered Voters', 'fill-color', [
			'interpolate',
			['linear'],
			['abs', ['-', ['get', 'RPCT'], ['get', 'DPCT']]],
			// Define breakpoints for margin values and corresponding colors
			0, [
				'case',
				['>', ['get', 'RPCT'], ['get', 'DPCT']], 
				'#FFBFBF', // Light red for R with small margin
				'#BFBFFF'  // Light blue for D with small margin
			],
			25, [
				'case',
				['>', ['get', 'RPCT'], ['get', 'DPCT']], 
				'#FF8080', // Darker red for R
				'#8080FF'  // Darker blue for D
			],
			50, [
				'case',
				['>', ['get', 'RPCT'], ['get', 'DPCT']], 
				'#FF4040', // Even darker red for R
				'#4040FF'  // Even darker blue for D
			],
			75, [
				'case',
				['>', ['get', 'RPCT'], ['get', 'DPCT']], 
				'#FF0000', // Darkest red for R
				'#0000FF'  // Darkest blue for D
			]
		]);
		
		// Set up the choropleth color scale for 'Broadband Cities' based on the pct_served (which is a decimal in this case)
		map.setPaintProperty('Broadband Cities', 'fill-color', [
			'interpolate',
			['linear'],
			['get', 'pct_served'], // Feature property to base the colors on
			0, '#ffffd4',  
			0.2, '#fee391',
			0.4, '#fec44f',
			0.6, '#fe9929',
			0.8, '#d95f0e',  
			1, '#993404'   
		]);
		
		
		// Optionally adjust the opacity if needed
		map.setPaintProperty('2020 Presidential', 'fill-opacity', 0.6);
		map.setPaintProperty('Broadband Counties', 'fill-opacity', 0.6);
		
		// Name each of the Data layers
		const DemographicLayers = [
			'Journalists per County', 
			'Outlets per County', 
			'Race % - White', 
			'Race % - Hispanic', 
			'Education', 
			'US Born', 
			'Veterans', 
			'Own vs. Rent', 
			'2020 Presidential', 
			'Registered Voters', 
			'Broadband Cities', 
			'Broadband Counties'
		];
		
		// Layer switcher for Demographics layers
		const layerSwitcher = document.getElementById('layer-switcher');
		layerSwitcher.addEventListener('change', function() {
		
			for (const id of DemographicLayers) {
				map.setLayoutProperty(id, 'visibility', 'none');
			}
			
			// Show the selected layer
			const selectedLayer = this.value;
			
			if(DemographicLayers.includes(selectedLayer)) {
				map.setLayoutProperty(selectedLayer, 'visibility', 'visible');
			};
			
		});

		// Name the news layers.
		const toggleableDataLayers = [
			'Local and Statewide Outlets',
			'TV and Radio Coverage',
			'Nebraska Public Media'
		];
		
		

		// Set up the toggles for each layer.
		for (const id of toggleableDataLayers) {
			// Skip layers that already have a button set up.
			if (document.getElementById(id)) {
				continue;
			}

			// Create a link.
			const link = document.createElement('a');
			link.id = id;
			link.href = '#';
			link.textContent = id;
			
			if (link.id=="Local and Statewide Outlets") {
			link.className = 'active';
			} else {
				link.className = '';
			};

			// Show or hide layer when the toggle is clicked.
			link.onclick = function (e) {
				
				const clickedLayer = this.textContent;
				e.preventDefault();
				e.stopPropagation();
				
				console.log("Layer clicked: ", clickedLayer);
			
				const visibility = map.getLayoutProperty(
					clickedLayer,
					'visibility'
				);
			
				// Toggle layer visibility by changing the layout object's visibility property when clicked.
				if (visibility === 'visible') { // if already visible, turn it off
					map.setLayoutProperty(clickedLayer, 'visibility', 'none');
					this.className = '';
				} else { // If visibility is 'none' -- All non-default layers
					if(this.className === 'active') { // if the link is already marked active (default layer only)
						this.className='';
						map.setLayoutProperty(
							clickedLayer,
							'visibility',
							'none'
						);
					} else { // if layer isn't visible, activate it when clicked
						this.className = 'active';
						map.setLayoutProperty(
							clickedLayer,
							'visibility',
							'visible'
						);
					}
				}
			
			};

			const layers = document.getElementById('menu-news');
			layers.appendChild(link);
		}
		
		
	});
		var currentPopup;
		
		// Map adjustment: Instead of separating all the map.on loads, 
		// Make one big map.on function that uses queryRenderedFeatures to return everything
		// then use conditionals inside to ADD content to the existing popup based on the feature types. 
		// At that point, maybe using a static div (a la, FFP Voter Guide) would be a better idea than a popup at the click location. 
		
		
		// Journalists per County popups
		map.on('click', function (e) {
			
			const localOutlets = map.queryRenderedFeatures(e.point, { layers: ['Local and Statewide Outlets'] });
			const journalistsPerCounty = map.queryRenderedFeatures(e.point, { layers: ['Journalists per County'] });
			const tvAndRadioCoverage = map.queryRenderedFeatures(e.point, { layers: ['TV and Radio Coverage'] });
			const nebraskaPublicMedia = map.queryRenderedFeatures(e.point, { layers: ['Nebraska Public Media'] });
			
			
			// Close the current popup if it exists and set the location to the clicked point
			
			if (currentPopup) {
				currentPopup.remove();
			}
			currentPopup = new mapboxgl.Popup().setLngLat(e.lngLat);
			
			
			// Clear the popup content
			let popupContent = ''
			
			
			// JOURNALISTS PER COUNTY
			if (journalistsPerCounty.length > 0) {
				
				const countyData = journalistsPerCounty[0];
						
				var county = countyData.properties.NAMELSAD;
				var fulltime = countyData.properties.COUNTY_FT;
				var parttime = countyData.properties.COUNTY_PT;
				
				popupContent +=
						"<h3>Journalists in " + county + "</h3>" +
						"<table><tbody>" +
						"<tr><td>Full-time</td><td>" + fulltime + "</td></tr>" +
						"<tr><td>Part-time</td><td>" + parttime + "</td></tr>" +
						"</tbody></table>";
			}
			
			
			// NEBRASKA PUBLIC MEDIA
			if(nebraskaPublicMedia.length > 0) {
				console.log({nebraskaPublicMedia});
				
				popupContent =  "<h3>Stations at this location: " + nebraskaPublicMedia.length + "</h3><table><tbody>";
			
				nebraskaPublicMedia.forEach((feature) => {
					const props = feature.properties;
					var callsign = props.callsign;
					var freq = props.frequency;
					var service = props.newsorg_am 
					var owner = props.newsorg_ow;
					popupContent += "<tr><td>" + callsign + "</td><td>" + service + "</td><tr>";
				});
			
				popupContent += "</tbody></table>";
			
			}
			
			
			// TV and Radio Coverage


//Outlets per County
//Race % - White
//Race % - Hispanic
//Education
//US Born
//Veterans
//Own vs. Rent
//2020 Presidential
//Registered Voters
//Broadband Cities
//Broadband Counties	
			
			
			// LOCAL AND STATEWIDE OUTLETS
			// If there are outlets at that point, get the details
			if (localOutlets.length > 0) {
				
				console.log({localOutlets});
				
				popupContent += "<h3 class='outlets'>Outlets at this location</h3><table class='outlets'><tbody>";
				
				localOutlets.forEach((outlet) => {
					var outletName = outlet.properties.newsorg_na;
					var outletOwner = outlet.properties.newsorg_ow;
					popupContent += "<tr><td>" + outletName + "</td><td>" + outletOwner + "</td><tr>";
				});
				
				popupContent += "</tbody></table>"
			
			
			}

			if (popupContent) {
			currentPopup.setHTML(popupContent).addTo(map);
			}
		
		}); // This is the end of map.on('click');
		
	
	// change the cursor to pointer when hovering over map features
	map.on('mousemove', (e) => {
		const features = map.queryRenderedFeatures(e.point);
		if (features.length) {
			map.getCanvas().style.cursor = 'pointer'; // Change cursor to pointer
		} else {
			map.getCanvas().style.cursor = ''; // Reset cursor when not hovering over any feature
		}
	});
		
</script>

</body>
</html>