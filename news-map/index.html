<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>COJMC News Map - Layers</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">


<link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>

<!-- Load the `mapbox-gl-geocoder` plugin. -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

<style>
	body { margin: 0; padding: 0; font-family: system-ui, sans-serif; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
	
	.map-menu { background: #fff; position: absolute; z-index: 1; left: 10px; width: 175px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.15); border-radius: 5px; }
	
	#menu-news { top: 60px; }
	#menu-demographics { bottom: 10px; }

	.map-menu a { font-size: 13px; color: #404040; display: block; margin: 0; padding: 10px; text-decoration: none; border-bottom: 1px solid rgba(0, 0, 0, 0.25); text-align: left; }

	.map-menu a:last-child { border: none; }

	.map-menu a:hover { background-color: #f8f8f8; color: #404040; }

	.map-menu a.active { background-color: #404040; color: #ffffff; }
	
	.map-menu p { padding: 10px; margin: 0; font-size: 13px; background: #d00000; color: #fff; font-weight: bold; }
	#menu-demographics p { background: #eee; color: #000; font-weight: bold; }
	
	.map-overlay {  position: absolute;  bottom: 0; right: 0; background: rgba(255,255,255,0.8);  margin-right: 10px;  font-size: 12px;   overflow: auto; padding: 10px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.15); }
		
	#legend {  box-shadow: 0 1px 2px rgba(0 0 0 0.1); line-height: 18px; height: 50px; margin-bottom: 30px; width: 100px; }
	
	.legend-key { display: inline-block; width: 10px; height: 10px; margin-right: 5px; }
	
	.mapboxgl-popup { max-width: 320px; }
	.mapboxgl-popup-content { font-family: system-ui, sans-serif; padding: 15px; border-radius: 8px; }
	.mapboxgl-popup-content p { font-size: 13px; line-height: 1.5; margin: 0; }
	.mapboxgl-popup-content p.small { font-size: 11px; color: #aaa; margin-bottom: 5px; }
	.mapboxgl-popup-content h3 { margin: 0 0 5px 0; }
	.mapboxgl-popup-content table { width: 100%; border-collapse: collapse; margin-top: 5px; color: #666; }
	.mapboxgl-popup-content table th { text-transform: uppercase; font-size: 90%; text-align: left; padding: 3px 0; border-bottom: 1px solid #ccc; font-weight: normal; color: #999; }
	.mapboxgl-popup-content table td { vertical-align: top; padding: 5px 0; border-bottom: 1px solid #eee; font-weight: 400; line-height: 1.3; }
	.mapboxgl-popup-content table td:first-child { padding-right: 10px; font-weight: 600; }
	
</style>

</head>

<body>

	<nav id="menu-news" class="map-menu"><p>News Layers</nav>
	<nav id="menu-demographics" class="map-menu"><p>Demographics</nav>

	<div id="map"></div>

	<div class="map-overlay" id="legend">
		<p>[ Map legend can go down here? ]</p>
	</div>

<script>
	
	// Eds note: Does this work? 
	const bounds = [  
		[ -108.32, 37.57 ],
		[ -90.35, 45.54 ]
	];  
	
	// Load initial map
	mapboxgl.accessToken = 'pk.eyJ1IjoiYnZhbmthdCIsImEiOiJjbHhlemU4bmcwMjVqMmxwdzRhYXNpMXR3In0.9nLycyn371SDdXa_rdOTuA'; //Mapbox token COJMC News Map
	
	const map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/bvankat/clzx3cfap007501qr6xlh9qn6',
		zoom: 5.5,
		maxZoom: 9,
		center: [-100, 41.5],
		maxBounds: bounds
	});
	
	// Add search control (geocoder)	
	const geocoder = new MapboxGeocoder({
		accessToken: mapboxgl.accessToken,
		mapboxgl: mapboxgl,
		placeholder: 'Find address or zip',
		bbox: [-104.053514, 39.999751, -95.30829, 43.001707] // Bounding box for Nebraska
	});
	
	// Zoom controls
	map.addControl(geocoder, 'top-left');
	map.scrollZoom.disable();
	var nav = new mapboxgl.NavigationControl();
	map.addControl(nav, 'top-right');
	
	
	// Let's add some layers
	
	map.on('load', function () {
	

		map.addSource('Demographics', {
			type: 'geojson',
			// Use a URL for the value for the `data` property.
			data: '../data/2022-5YACS-DEMOGRAPHICS.geojson',
			generateId: true
			});
		
		map.addLayer({
			'id': 'Race % - White',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'Race % - Hispanic',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'Bachelors Degree',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'US Born',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'Veterans',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		map.addLayer({
			'id': 'Own vs. Rent',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6
		  	}
		});
		
		const mapLayers = map.getStyle().layers;
		console.log('Layers loaded: ', mapLayers);
	});
	
	// After the last frame rendered before the map enters an "idle" state.
	map.on('idle', () => {
		
		// Set up the choropleth color scale based on the margin of victory
		map.setPaintProperty('2020 Presidential', 'fill-color', [
			'interpolate',
			['linear'],
			['abs', ['-', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']]],
			// Define breakpoints for margin values and corresponding colors
			0, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FFBFBF', // Light red for Trump with small margin
				'#BFBFFF'  // Light blue for Biden with small margin
			],
			25, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF8080', // Darker red for Trump
				'#8080FF'  // Darker blue for Biden
			],
			50, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF4040', // Even darker red for Trump
				'#4040FF'  // Even darker blue for Biden
			],
			75, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF0000', // Darkest red for Trump
				'#0000FF'  // Darkest blue for Biden
			]
		]);
		
		// Optionally adjust the opacity if needed
		map.setPaintProperty('2020 Presidential', 'fill-opacity', 0.3);
		map.setPaintProperty('Broadband Counties', 'fill-opacity', 0.3);
		
		

		// Enumerate ids of the layers.
		const toggleableDataLayers = [
			'TV and Radio Coverage',
			'Nebraska Public Media',
			'Statewide - Print and Digital',
			'Local News - Print and Digital',
			'Journalists per County',
		];
		
		const toggleableDemographicLayers = [
			'Race % - White', 
			'Race % - Hispanic', 
			'Bachelors Degree', 
			'US Born', 
			'Veterans', 
			'Own vs. Rent', 
			'2020 Presidential', 
			'Registered Voters', 
			'Broadband Cities', 
			'Broadband Counties', 
		];

		// Set up the toggles for each layer.
		for (const id of toggleableDataLayers) {
			// Skip layers that already have a button set up.
			if (document.getElementById(id)) {
				continue;
			}

			// Create a link.
			const link = document.createElement('a');
			link.id = id;
			link.href = '#';
			link.textContent = id;
			if (link.id==="Journalists per County") {
				link.className = 'active';
			} else {
				link.className = '';
			};

			// Show or hide layer when the toggle is clicked.
			link.onclick = function (e) {
				const clickedLayer = this.textContent;
				e.preventDefault();
				e.stopPropagation();
			
				const visibility = map.getLayoutProperty(
					clickedLayer,
					'visibility'
				);
			
				// Toggle layer visibility by changing the layout object's visibility property.
				if (visibility === 'visible') {
					map.setLayoutProperty(clickedLayer, 'visibility', 'none');
					this.className = '';
				} else {
					this.className = 'active';
					map.setLayoutProperty(
						clickedLayer,
						'visibility',
						'visible'
					);
				}
			
			};

			const layers = document.getElementById('menu-news');
			layers.appendChild(link);
		}



		for (const id of toggleableDemographicLayers) {
			// Skip layers that already have a button set up.
			if (document.getElementById(id)) {
				continue;
			}

			// Create a link.
			const link = document.createElement('a');
			link.id = id;
			link.href = '#';
			link.textContent = id;
			link.className = '';

			// Show or hide layer when the toggle is clicked.
			link.onclick = function (e) {
				const clickedLayer = this.textContent;
				e.preventDefault();
				e.stopPropagation();
			
				const visibility = map.getLayoutProperty(
					clickedLayer,
					'visibility'
				);
			
				// Toggle layer visibility by changing the layout object's visibility property.
				if (visibility === 'visible') {
					map.setLayoutProperty(clickedLayer, 'visibility', 'none');
					this.className = '';
				} else {
					this.className = 'active';
					map.setLayoutProperty(
						clickedLayer,
						'visibility',
						'visible'
					);
				}
			
			};

			const layers = document.getElementById('menu-demographics');
			layers.appendChild(link);
		}
		
		
	});
		var currentPopup;
		
		// TV and Radio Stations popups
		map.on('click', 'TV and Radio Coverage', function (e) {
			
			console.log("You clicked on: ", e);
			console.log("Features at this point: ", e.features.length, e.features);
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			currentPopup = new mapboxgl.Popup()
			.setLngLat(e.lngLat)
						
			let popupContent =  "<h3>Stations at this location: " + e.features.length + "</h3>" + "<table><tbody>";
			
			e.features.forEach((feature) => {
				const props = feature.properties;
				var callsign = props.callsign;
				var freq = props.frequency;
				var service = props.newsorg_am 
				var owner = props.newsorg_ow;
				popupContent += "<tr><td>" + callsign + "</td><td>" + freq + " " + service + "</td><tr>";
			});
			
			popupContent += "</tbody></table>";
			
			currentPopup.setHTML(popupContent)
			.addTo(map);

		});
		
		
		
		// Nebaska Public Media popups
		map.on('click', 'Nebraska Public Media', function (e) {
			
			console.log("You clicked on: ", e);
			console.log("Features at this point: ", e.features.length, e.features);
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			currentPopup = new mapboxgl.Popup()
			.setLngLat(e.lngLat)
						
			let popupContent =  "<h3>Stations at this location: " + e.features.length + "</h3>" + "<table><tbody>";
			
			e.features.forEach((feature) => {
				const props = feature.properties;
				var callsign = props.callsign;
				var freq = props.frequency;
				var service = props.newsorg_am 
				var owner = props.newsorg_ow;
				popupContent += "<tr><td>" + callsign + "</td><td>" + service + "</td><tr>";
			});
			
			popupContent += "</tbody></table>";
			
			currentPopup.setHTML(popupContent)
			.addTo(map);

		});
		
		
		// Local News popups
		map.on('click', 'Local News - Print and Digital', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			console.log("Features at this location: ", e.features.length, e.features);
			
			currentPopup = new mapboxgl.Popup()
			.setLngLat(e.lngLat)
						
			let popupContent =  "<h3>Outlets at this location: " + e.features.length + "</h3>" + 
			"<table><thead><th>Name</th><th>Owner</th></thead><tbody>";
			
			e.features.forEach((feature) => {
				const props = feature.properties;
				var name = props.newsorg_na;
				var county = props.newsorg_co;
				var city = props.City
				var owner = e.features[0].properties.newsorg_ow;
								
				popupContent += "<tr><td>" + name + "</td><td>" + owner + "</td><tr>";
			});
			
			popupContent += "</tbody></table>";
			
			currentPopup.setHTML(popupContent)
			.addTo(map);
		});
		
		// Statewide orgs popups
		map.on('click', 'Statewide - Print and Digital', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			console.log("Features at this location: ", e.features.length, e.features);
			
			currentPopup = new mapboxgl.Popup()
			.setLngLat(e.lngLat)
						
			let popupContent =  "<h3>Outlets at this location: " + e.features.length + "</h3>" + "<table><thead><th>Name</th><th>Owner</th></thead><tbody>";
			
			e.features.forEach((feature) => {
				const props = feature.properties;
				var name = props.newsorg_name;
				var county = props.newsorg_county;
				var city = props.newsorg_muni;
				var owner = e.features[0].properties.newsorg_owner;
								
				popupContent += "<tr><td>" + name + "</td><td>" + owner + "</td><tr>";
			});
			
			popupContent += "</tbody></table>";
			
			currentPopup.setHTML(popupContent)
			.addTo(map);
			
		});
		
		
		// Journalists per County popups
		map.on('click', 'Journalists per County', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAMELSAD;
			var fulltime = e.features[0].properties.COUNTY_FT;
			var parttime = e.features[0].properties.COUNTY_PT;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>Journalists in " + county + "</h3>" +
					"<table><tbody>" +
					"<tr><td>Full-time</td><td>" + fulltime + "</td></tr>" +
					"<tr><td>Part-time</td><td>" + parttime + "</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
		
		// 2020 Presidential layer popups
		map.on('click', '2020 Presidential', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var coordinates = e.features[0].geometry.coordinates.slice();
			var county = e.features[0].properties.NAME;
			var trump = e.features[0].properties.Trump_PCT;
			var biden = e.features[0].properties.Biden_PCT;
			var margin = Math.abs(trump - biden).toFixed(2); // Rounded to 2 decimal places
			var winner = trump > biden ? 'Trump' : 'Biden'; // Determine the winner
		
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML("<p><strong>" + county + " County</strong></p><p>2020 result: " + winner + " +" + margin + "%</p")
				.addTo(map);
		});
		
		// Demographics layer popups
		map.on('click', 'Race % - White', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var coordinates = e.features[0].geometry.coordinates.slice();
			var county = e.features[0].properties.NAMELSAD;
			var asian = e.features[0].properties.Asian;
			var black = e.features[0].properties.Black;
			var hispanic = e.features[0].properties.Hispanic;
			var white = e.features[0].properties.White;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>POPULATION BY RACE</p>" +
					"<p>Asian: " + asian + "%</p>" +
					"<p>Black: " + black + "%</p>" + 
					"<p>Hispanic: " + hispanic + "%</p>" +
					"<p>White: " + white + "%</p>")
				.addTo(map);
		});
		
		map.on('click', 'Race % - Hispanic', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var coordinates = e.features[0].geometry.coordinates.slice();
			var county = e.features[0].properties.NAMELSAD;
			var asian = e.features[0].properties.Asian;
			var black = e.features[0].properties.Black;
			var hispanic = e.features[0].properties.Hispanic;
			var white = e.features[0].properties.White;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>POPULATION BY RACE</p>" +
					"<p>Asian: " + asian + "%</p>" +
					"<p>Black: " + black + "%</p>" + 
					"<p>Hispanic: " + hispanic + "%</p>" +
					"<p>White: " + white + "%</p>")
				.addTo(map);
		});
		
		// County staffing popups
		map.on('click', 'Staffing - Counties', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var coordinates = e.features[0].geometry.coordinates.slice();
			var county = e.features[0].properties.NAMELSAD;
			var county_ft = e.features[0].properties.COUNTY_FT;
			var county_pt = e.features[0].properties.COUNTY_PT;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p>Journalists working in the county</p>" +
					"<table><tbody>" +
					"<tr><td>Full-time</td><td>" + county_ft + "</td><tr>" + 
					"<tr><td>Part-time</td><td>" + county_pt + "</td><tr>" + 
					"</tbody></table>")
				.addTo(map);
		});
		
	
	// change the cursor to pointer when hovering over map features
	map.on('mousemove', (e) => {
		const features = map.queryRenderedFeatures(e.point);
		if (features.length) {
			map.getCanvas().style.cursor = 'pointer'; // Change cursor to pointer
		} else {
			map.getCanvas().style.cursor = ''; // Reset cursor when not hovering over any feature
		}
	});
		
</script>

</body>
</html>