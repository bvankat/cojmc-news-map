<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>COJMC News Map - Layers</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">


<link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>

<!-- Load the `mapbox-gl-geocoder` plugin. -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

<style>
	body { margin: 0; padding: 0; font-family: system-ui, sans-serif; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
	
	.map-menu { background: #fff; position: absolute; z-index: 1; left: 10px; width: 200px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.15); border-radius: 5px; }
	
	#menu-news { top: 60px; }
	#menu-demographics { bottom: 40px;}
	
	#menu-demographics select { appearance: none; cursor: pointer; font-size: 12px; border: 1px solid #eee; padding: 5px; margin: 10px; border: 1px solid #eee; }

	.map-menu a { font-size: 13px; color: #404040; display: block; margin: 0; padding: 10px; text-decoration: none; border-bottom: 1px solid rgba(0, 0, 0, 0.25); text-align: left; }

	.map-menu a:last-child { border: none; }

	.map-menu a:hover { background-color: #f8f8f8; color: #404040; }

	.map-menu a.active { background-color: #404040; color: #ffffff; }
	
	.map-menu p { padding: 10px; margin: 0; font-size: 13px; background: #d00000; color: #fff; font-weight: bold; }
	#menu-demographics p { background: #404040; color: #fff; font-weight: bold; }
	
	.map-overlay {  position: absolute;  bottom: 0; right: 0; background: rgba(255,255,255,0.8);  margin-right: 10px;  font-size: 12px;   overflow: auto; padding: 10px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: 0 0 20px rgba(0,0,0,0.15); }
		
	#legend {  box-shadow: 0 1px 2px rgba(0 0 0 0.1); line-height: 18px; height: 50px; margin-bottom: 30px; width: 100px; }
	
	.legend-key { display: inline-block; width: 10px; height: 10px; margin-right: 5px; }
	
	.mapboxgl-popup { max-width: 320px; }
	.mapboxgl-popup-content { font-family: system-ui, sans-serif; padding: 15px; border-radius: 8px; }
	.mapboxgl-popup-content p { font-size: 13px; line-height: 1.5; margin: 0; }
	.mapboxgl-popup-content p.small { font-size: 11px; color: #aaa; margin-bottom: 5px; }
	.mapboxgl-popup-content h3 { margin: 0 0 5px 0; }
	.mapboxgl-popup-content table { width: 100%; border-collapse: collapse; margin-top: 5px; color: #666; }
	.mapboxgl-popup-content table th { text-transform: uppercase; font-size: 90%; text-align: left; padding: 3px 0; border-bottom: 1px solid #ccc; font-weight: normal; color: #999; }
	.mapboxgl-popup-content table td { vertical-align: top; padding: 5px 0; border-bottom: 1px solid #eee; font-weight: 400; line-height: 1.3; padding-right: 10px; }
	.mapboxgl-popup-content table td:first-child { font-weight: 600; }
	.mapboxgl-popup-content table td:last-child { padding-right: 0; }
	.mapboxgl-popup-content table.numbers td:last-child { text-align: right; }
	
</style>

</head>

<body>

	<nav id="menu-news" class="map-menu"><p>NEWS OUTLETS</p></nav>
	
	<nav id="menu-demographics" class="map-menu"><p>DATA LAYERS</p>
		<select id="layer-switcher">
			<option value="">Select a layer</option>
			<option value="Journalists per County" selected>Journalists per County</option>
			<option value="Outlets per County">News Outlets per County</option>
			<option value="Race % - White">White %</option>
			<option value="Race % - Hispanic">Hispanic %</option>
			<option value="US Born">U.S. Citizenship</option>
			<option value="Veterans">Veterans</option>
			<option value="Own vs. Rent">Home Ownership</option>
			<option value="Education">Education</option>
			<option value="2020 Presidential">2020 Election</option>
			<option value="Registered Voters">Registered Voters</option>
			<option value="Broadband Counties">Broadband - Counties</option>
			<option value="Broadband Cities">Broadband - Cities</option>
		</select>
	</nav>

	<div id="map"></div>

	<div class="map-overlay" id="legend">
		<p>[ Map legend can go down here? ]</p>
	</div>

<script>
	
	// Eds note: Does this work? 
	const bounds = [  
		[ -108.32, 37.57 ],
		[ -90.35, 45.54 ]
	];  
	
	// Load initial map
	mapboxgl.accessToken = 'pk.eyJ1IjoiYnZhbmthdCIsImEiOiJjbHhlemU4bmcwMjVqMmxwdzRhYXNpMXR3In0.9nLycyn371SDdXa_rdOTuA'; //Mapbox token COJMC News Map
	
	const map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/bvankat/clzx3cfap007501qr6xlh9qn6',
		zoom: 5.5,
		maxZoom: 9,
		center: [-100, 41.5],
		maxBounds: bounds
	});
	
	// Add search control (geocoder)	
	const geocoder = new MapboxGeocoder({
		accessToken: mapboxgl.accessToken,
		mapboxgl: mapboxgl,
		placeholder: 'Find address or zip',
		bbox: [-104.053514, 39.999751, -95.30829, 43.001707] // Bounding box for Nebraska
	});
	
	// Zoom controls
	map.addControl(geocoder, 'top-left');
	map.scrollZoom.disable();
	var nav = new mapboxgl.NavigationControl();
	map.addControl(nav, 'top-right');
	
	
	// Let's add some layers
	
	map.on('load', function () {
	

		map.addSource('Demographics', {
			type: 'geojson',
			// Use a URL for the value for the `data` property.
			data: '../data/2022-5YACS-DEMOGRAPHICS.geojson',
			generateId: true
			});
		
		map.addLayer({
			'id': 'Race % - White',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'White'], // Feature property to base the colors on
					0, '#ffffd4',  
					20, '#fee391',
					40, '#fec44f',
					60, '#fe9929',
					80, '#d95f0e',  
					100, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'Race % - Hispanic',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'Hispanic'], // Feature property to base the colors on
					0, '#ffffd4',  
					10, '#fee391',
					20, '#fec44f',
					30, '#fe9929',
					40, '#d95f0e',  
					50, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'Education',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'Bach'], // Feature property to base the colors on
					5, '#ffffd4',  
					10, '#fee391',
					15, '#fec44f',
					20, '#fe9929',
					25, '#d95f0e',  
					30, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'US Born',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'USb'], // Feature property to base the colors on
					0, '#ffffd4',  
					20, '#fee391',
					40, '#fec44f',
					60, '#fe9929',
					80, '#d95f0e',  
					100, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'Veterans',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'Veteran'], // Feature property to base the colors on
					0, '#ffffd4',  
					10, '#fee391',
					20, '#fec44f',
					30, '#fe9929',
					40, '#d95f0e',  
					50, '#993404'   
				]
		  	}
		}); 
		
		map.addLayer({
			'id': 'Own vs. Rent',
			'type': 'fill',
			'source': 'Demographics',
			'layout': {
				'visibility': 'none'
			},
			'paint': {
				'fill-opacity': 0.6,
				'fill-outline-color': '#000000',
				'fill-color': [
					'interpolate',
					['linear'],
					['get', 'Owneroccupied'], // Feature property to base the colors on
					0, '#ffffd4',  
					20, '#fee391',
					40, '#fec44f',
					60, '#fe9929',
					80, '#d95f0e',  
					100, '#993404'   
				]
		  	}
		}); 
		
		// Move layer to top
		map.moveLayer('Local and Statewide Outlets', 'Journalists per County');
			
		const mapLayers = map.getStyle().layers;
		console.log('Layers loaded: ', mapLayers);
	});
	
	// After the last frame rendered before the map enters an "idle" state.
	map.on('idle', () => {
		
		// Set up the choropleth color scale for '2020 Presidential' based on the margin of victory
		map.setPaintProperty('2020 Presidential', 'fill-color', [
			'interpolate',
			['linear'],
			['abs', ['-', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']]],
			// Define breakpoints for margin values and corresponding colors
			0, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FFBFBF', // Light red for Trump with small margin
				'#BFBFFF'  // Light blue for Biden with small margin
			],
			25, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF8080', // Darker red for Trump
				'#8080FF'  // Darker blue for Biden
			],
			50, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF4040', // Even darker red for Trump
				'#4040FF'  // Even darker blue for Biden
			],
			75, [
				'case',
				['>', ['get', 'Trump_PCT'], ['get', 'Biden_PCT']], 
				'#FF0000', // Darkest red for Trump
				'#0000FF'  // Darkest blue for Biden
			]
		]);
		
		// Set up the choropleth color scale for 'Registered Voters' based on the highest registrations
		map.setPaintProperty('Registered Voters', 'fill-color', [
			'interpolate',
			['linear'],
			['abs', ['-', ['get', 'RPCT'], ['get', 'DPCT']]],
			// Define breakpoints for margin values and corresponding colors
			0, [
				'case',
				['>', ['get', 'RPCT'], ['get', 'DPCT']], 
				'#FFBFBF', // Light red for R with small margin
				'#BFBFFF'  // Light blue for D with small margin
			],
			25, [
				'case',
				['>', ['get', 'RPCT'], ['get', 'DPCT']], 
				'#FF8080', // Darker red for R
				'#8080FF'  // Darker blue for D
			],
			50, [
				'case',
				['>', ['get', 'RPCT'], ['get', 'DPCT']], 
				'#FF4040', // Even darker red for R
				'#4040FF'  // Even darker blue for D
			],
			75, [
				'case',
				['>', ['get', 'RPCT'], ['get', 'DPCT']], 
				'#FF0000', // Darkest red for R
				'#0000FF'  // Darkest blue for D
			]
		]);
		
		// Set up the choropleth color scale for 'Brodband Cities' based on the pct_served (which is a decimal in this case)
		map.setPaintProperty('Broadband Cities', 'fill-color', [
			'interpolate',
			['linear'],
			['get', 'pct_served'], // Feature property to base the colors on
			0, '#ffffd4',  
			0.2, '#fee391',
			0.4, '#fec44f',
			0.6, '#fe9929',
			0.8, '#d95f0e',  
			1, '#993404'   
		]);
		
		
		// Optionally adjust the opacity if needed
		map.setPaintProperty('2020 Presidential', 'fill-opacity', 0.6);
		map.setPaintProperty('Broadband Counties', 'fill-opacity', 0.6);
		
		// Name each of the Data layers
		const DemographicLayers = [
			'Journalists per County', 
			'Outlets per County', 
			'Race % - White', 
			'Race % - Hispanic', 
			'Education', 
			'US Born', 
			'Veterans', 
			'Own vs. Rent', 
			'2020 Presidential', 
			'Registered Voters', 
			'Broadband Cities', 
			'Broadband Counties'
		];
		
		// Layer switcher for Demographics layers
		const layerSwitcher = document.getElementById('layer-switcher');
		layerSwitcher.addEventListener('change', function() {
		
			for (const id of DemographicLayers) {
				map.setLayoutProperty(id, 'visibility', 'none');
			}
			
			// Show the selected layer
			const selectedLayer = this.value;
			
			if(DemographicLayers.includes(selectedLayer)) {
				map.setLayoutProperty(selectedLayer, 'visibility', 'visible');
			};
			
		});

		// Name the news layers.
		const toggleableDataLayers = [
			'Local and Statewide Outlets',
			'TV and Radio Coverage',
			'Nebraska Public Media'
		];
		

		// Set up the toggles for each layer.
		for (const id of toggleableDataLayers) {
			// Skip layers that already have a button set up.
			if (document.getElementById(id)) {
				continue;
			}

			// Create a link.
			const link = document.createElement('a');
			link.id = id;
			link.href = '#';
			link.textContent = id;
			
			if (link.id=="Local and Statewide Outlets") {
			link.className = 'active';
			} else {
				link.className = '';
			};

			// Show or hide layer when the toggle is clicked.
			link.onclick = function (e) {
				
				const clickedLayer = this.textContent;
				e.preventDefault();
				e.stopPropagation();
				
				console.log("Layer clicked: ", clickedLayer);
			
				const visibility = map.getLayoutProperty(
					clickedLayer,
					'visibility'
				);
			
				// Toggle layer visibility by changing the layout object's visibility property when clicked.
				if (visibility === 'visible') { // if already visible, turn it off
					map.setLayoutProperty(clickedLayer, 'visibility', 'none');
					this.className = '';
				} else { // If visibility is 'none' -- All non-default layers
					if(this.className === 'active') { // if the link is already marked active (default layer only)
						this.className='';
						map.setLayoutProperty(
							clickedLayer,
							'visibility',
							'none'
						);
					} else { // if layer isn't visible, activate it when clicked
						this.className = 'active';
						map.setLayoutProperty(
							clickedLayer,
							'visibility',
							'visible'
						);
					}
				}
			
			};

			const layers = document.getElementById('menu-news');
			layers.appendChild(link);
		}
		
		
	});
		var currentPopup;
		
		// Map adjustment: Instead of separating all the map.on loads, 
		// Make one big map.on function that uses queryRenderedFeatures to return everything
		// then use conditionals inside to ADD content to the existing popup based on the feature types. 
		// At that point, maybe using a static div (a la, FFP Voter Guide) would be a better idea than a popup at the click location. 
		
		// TV and Radio Stations popups
		map.on('click', 'TV and Radio Coverage', function (e) {
			
			console.log("You clicked on: ", e);
			console.log("Features at this point: ", e.features.length, e.features);
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			currentPopup = new mapboxgl.Popup()
			.setLngLat(e.lngLat)
						
			let popupContent =  "<h3>Stations at this location: " + e.features.length + "</h3>" + "<table><tbody>";
			
			e.features.forEach((feature) => {
				const props = feature.properties;
				var callsign = props.callsign;
				var freq = props.frequency;
				var service = props.newsorg_am 
				var owner = props.newsorg_ow;
				popupContent += "<tr><td>" + callsign + "</td><td>" + freq + " " + service + "</td><tr>";
			});
			
			popupContent += "</tbody></table>";
			
			currentPopup.setHTML(popupContent)
			.addTo(map);

		});
		
		
		
		// Nebaska Public Media popups
		map.on('click', 'Nebraska Public Media', function (e) {
			
			console.log("You clicked on: ", e);
			console.log("Features at this point: ", e.features.length, e.features);
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			currentPopup = new mapboxgl.Popup()
			.setLngLat(e.lngLat)
						
			let popupContent =  "<h3>Stations at this location: " + e.features.length + "</h3>" + "<table><tbody>";
			
			e.features.forEach((feature) => {
				const props = feature.properties;
				var callsign = props.callsign;
				var freq = props.frequency;
				var service = props.newsorg_am 
				var owner = props.newsorg_ow;
				popupContent += "<tr><td>" + callsign + "</td><td>" + service + "</td><tr>";
			});
			
			popupContent += "</tbody></table>";
			
			currentPopup.setHTML(popupContent)
			.addTo(map);

		});
		
		
		// News Outlets popups
		map.on('click', 'Local and Statewide Outlets', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			};
			
			console.log("Outlets at this location: ", e.features.length, e.features);
			
			currentPopup = new mapboxgl.Popup().setLngLat(e.lngLat);
						
			let popupContent =  "<h3>Outlets at this location: " + e.features.length + "</h3>" + 
			"<table><thead><th>Name</th><th>Owner</th></thead><tbody>";
			
			e.features.forEach((feature) => {
				const props = feature.properties;
				var name = props.newsorg_na;
				var owner = props.newsorg_ow;
								
				popupContent += "<tr><td>" + name + "</td><td>" + owner + "</td><tr>";
			});
			
			popupContent += "</tbody></table>";
			
			currentPopup.setHTML(popupContent).addTo(map);
						
		});
		
		
		// Journalists per County popups
		map.on('click', 'Journalists per County', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
						
			var county = e.features[0].properties.NAMELSAD;
			var fulltime = e.features[0].properties.COUNTY_FT;
			var parttime = e.features[0].properties.COUNTY_PT;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>Journalists in " + county + "</h3>" +
					"<table><tbody>" +
					"<tr><td>Full-time</td><td>" + fulltime + "</td></tr>" +
					"<tr><td>Part-time</td><td>" + parttime + "</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});

		// Outlets per County popups
		map.on('click', 'Outlets per County', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAMELSAD;
			var local_outlets = e.features[0].properties["Total LNOs"];
			var outlet_names = e.features[0].properties["LNO names"];
			
			if ( local_outlets == '' ){
				var outlet_names = "None";
			};
			
			var statewide_outlets = e.features[0].properties["Statewide news organizations"];
			
			if( statewide_outlets ) {
				const statewide_list = statewide_outlets.split(',');
				const statewide_count = statewide_list.length;
				
				currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>News Outlets in " + county + "</h3>" +
					"<table><tbody>" +
					"<tr><td>Local</td><td>" + local_outlets + "</td></tr>" +
					"<tr><td>Statewide</td><td>" + statewide_count + "</td></tr>" +
					"<tr><td colspan=2 style='font-weight: normal !important'>Local outlets: " + outlet_names + "</td></tr>" +
					"<tr><td colspan=2 style='font-weight: normal !important'>Statewide outlets: " + statewide_list + "</td></tr>" +
					"</tbody></table>")
				.addTo(map);
			} else {
			

			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>News Outlets in " + county + "</h3>" +
					"<table><tbody>" +
					"<tr><td>Local</td><td>" + local_outlets + "</td></tr></tbody></table>" +
					"<p style='margin-top: 5px; font-size: 12px; color #666'>Outlets: " + outlet_names + "</p>")
				.addTo(map);
				
			}
		});
		
		
		// 2020 Presidential layer popups
		map.on('click', '2020 Presidential', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAME;
			var trumpVotes = e.features[0].properties["2020-Trump"];
			var trump = e.features[0].properties.Trump_PCT;
			var bidenVotes = e.features[0].properties["2020-Biden"];
			var biden = e.features[0].properties.Biden_PCT;
			var margin = Math.abs(trump - biden).toFixed(1); // Rounded to 1 decimal places
			var winner = trump > biden ? 'Trump' : 'Biden'; // Determine the winner
		
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + " County</h3>" +
					"<p class='small'>2020 Election Result: " + winner + " +" + margin + "%</p>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>Trump</td><td> " + trumpVotes.toLocaleString() + "</td></tr>" +
					"<tr><td>Biden</td><td>" + bidenVotes.toLocaleString() + "</td></tr>" + 
					"</tbody></table>")
				.addTo(map);
		});
		
		// Demographics - White popups
		map.on('click', 'Race % - White', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAMELSAD;
			var asian = e.features[0].properties.Asian;
			var black = e.features[0].properties.Black;
			var hispanic = e.features[0].properties.Hispanic;
			var white = e.features[0].properties.White;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>POPULATION BY RACE</p>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>Asian</td><td> " + asian.toFixed(1) + "%</td></tr>" +
					"<tr><td>Black</td><td>" + black.toFixed(1) + "%</td></tr>" + 
					"<tr><td>Hispanic</td><td>" + hispanic.toFixed(1) + "%</td></tr>" +
					"<tr><td>White</td><td>" + white.toFixed(1) + "%</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
		
		// Demographics - Hispanic popups
		map.on('click', 'Race % - Hispanic', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAMELSAD;
			var asian = e.features[0].properties.Asian;
			var black = e.features[0].properties.Black;
			var hispanic = e.features[0].properties.Hispanic;
			var white = e.features[0].properties.White;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>POPULATION BY RACE</p>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>Asian</td><td> " + asian.toFixed(1) + "%</td></tr>" +
					"<tr><td>Black</td><td>" + black.toFixed(1) + "%</td></tr>" + 
					"<tr><td>Hispanic</td><td>" + hispanic.toFixed(1) + "%</td></tr>" +
					"<tr><td>White</td><td>" + white.toFixed(1) + "%</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
		
		// Demographics - Education
		map.on('click', 'Education', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAMELSAD;
			var noEdu = e.features[0].properties.NoEdu;
			var hsDip = e.features[0].properties.HSdip;
			var bach = e.features[0].properties.Bach;
			var masters = e.features[0].properties.Masters;
			var phd = e.features[0].properties.Phd;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>Highest education level obtained</p>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>No education</td><td>" + noEdu.toFixed(1) + "%</td></tr>" +
					"<tr><td>HS diploma</td><td>" + hsDip.toFixed(1) + "%</td></tr>" +
					"<tr><td>Bachelor</td><td>" + bach.toFixed(1) + "%</td></tr>" +
					"<tr><td>Masters</td><td>" + masters.toFixed(1) + "%</td></tr>" +
					"<tr><td>PhD</td><td>" + phd.toFixed(1) + "%</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
		
		// Demographics - US Born
		map.on('click', 'US Born', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAMELSAD;
			var usBorn = e.features[0].properties.USb;
			var naturalized = e.features[0].properties.Naturalized;
			var notCitizen = e.features[0].properties.Notcitizen;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>U.S. Born</td><td>" + usBorn.toFixed(1) + "%</td></tr>" +
					"<tr><td>Naturalized</td><td>" + naturalized.toFixed(1) + "%</td></tr>" +
					"<tr><td>Non-citizen</td><td>" + notCitizen.toFixed(1) + "%</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
		// Demographics - Veterans
		map.on('click', 'Veterans', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAMELSAD;
			var veteran = e.features[0].properties.Veteran;
			var notVeteran = e.features[0].properties.Nonvet;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>Veterans</td><td>" + veteran.toFixed(1) + "%</td></tr>" +
					"<tr><td>Non-veterans</td><td>" + notVeteran.toFixed(1) + "%</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
		// Demographics - Home ownership
		map.on('click', 'Own vs. Rent', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAMELSAD;
			var own = e.features[0].properties.Owneroccupied;
			var rent = e.features[0].properties.Renteroccupied;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>Total households</p>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>Owner-occupied</td><td>" + own.toFixed(1) + "%</td></tr>" +
					"<tr><td>Renter-occupied</td><td>" + rent.toFixed(1) + "%</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
		// Registered Voters
		map.on('click', 'Registered Voters', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.NAMELSAD;
			var voters = e.features[0].properties["Grand Total"];
			var republican = e.features[0].properties.Republican;
			var rPct = e.features[0].properties.RPCT;
			var democrat = e.features[0].properties.Democratic;
			var dPct = e.features[0].properties.DPCT;
			var nonpartisan = e.features[0].properties.Nonpartisan;
			var nPct = e.features[0].properties.NPCT;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>Registered Voters: " + voters.toLocaleString() + "</p>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>Republican</td><td>" + republican.toLocaleString() + "</td><td>" + rPct.toFixed(1) + "%</td></tr>" +
					"<tr><td>Democrat</td><td>" + democrat.toLocaleString() + "</td><td>" + dPct.toFixed(1) + "%</td></tr>" +
					"<tr><td>Nonpartisan</td><td>" + nonpartisan.toLocaleString() + "</td><td>" + nPct.toFixed(1) + "%</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
		
		//  Broadband Counties
		map.on('click', 'Broadband Counties', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var county = e.features[0].properties.county_nam;
			var broadbandPct = e.features[0].properties.pct_served;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + county + "</h3>" +
					"<p class='small'>Percentage of households and businesses with wired broadband</p>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>Broadband access</td><td>" + (broadbandPct * 100).toFixed(1) + "%</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
		
		//  Broadband Cities
		map.on('click', 'Broadband Cities', function (e) {
			
			// Close the current popup if it exists
			if (currentPopup) {
				currentPopup.remove();
			}
			
			var city = e.features[0].properties.city;
			var broadbandPct = e.features[0].properties.pct_served;
			
			currentPopup = new mapboxgl.Popup()
				.setLngLat(e.lngLat)
				.setHTML(
					"<h3>" + city + "</h3>" +
					"<p class='small'>Percentage of households and businesses with wired broadband</p>" +
					"<table class='numbers'><tbody>" +
					"<tr><td>Broadband access</td><td>" + (broadbandPct * 100).toFixed(1) + "%</td></tr>" +
					"</tbody></table>")
				.addTo(map);
		});
		
	
		
	
	// change the cursor to pointer when hovering over map features
	map.on('mousemove', (e) => {
		const features = map.queryRenderedFeatures(e.point);
		if (features.length) {
			map.getCanvas().style.cursor = 'pointer'; // Change cursor to pointer
		} else {
			map.getCanvas().style.cursor = ''; // Reset cursor when not hovering over any feature
		}
	});
		
</script>

</body>
</html>